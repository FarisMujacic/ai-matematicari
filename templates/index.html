<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAT-BOT</title>

  <script>
    MathJax = { tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] }, svg: { fontCache: "global" } };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>

  <style>
  :root{
    --page-bg:linear-gradient(180deg,#eef5ff 0%,#f7fbff 100%);
    --card-bg:rgba(255,255,255,.92);
    --card-border:rgba(0,0,0,.10);
    --text:#1a1a1a;
    --accent-bot:#4caf50;
    --accent-user:#05afc5;
    --bubble-bg:#eaf7e8;
    --bubble-text:#1a1a1a;
    --btn-bg:#2f6e5b;
    --btn-bg-hover:#255e4e;
    --danger:#c94f4f;
    --muted:#6b7a86;
    --input-bg:#f8fafd;
    --input-border:#dbe5ea;
    --type-bg:#fff3bf;
    --type-border:#ffb84d;
    --overlay: rgba(0,0,0,.45);
    --modal-bg: #ffffff;
    --modal-border: rgba(0,0,0,.08);
  }
  body.dark{
    --page-bg:linear-gradient(180deg,#0b1113 0%,#090d0f 100%);
    --card-bg:rgba(19,26,29,.94);
    --card-border:rgba(255,255,255,.18);
    --text:#e6edf0;
    --bubble-bg:#1e2a2f;
    --bubble-text:#e6edf0;
    --btn-bg:#2a4b42;
    --btn-bg-hover:#213c35;
    --muted:#a7bac4;
    --input-bg:#111a1d;
    --input-border:#203139;
    --type-bg:#0f1b20;
    --type-border:#3d7d66;
    --overlay: rgba(0,0,0,.6);
    --modal-bg:#162126;
    --modal-border: rgba(255,255,255,.12);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;background:var(--page-bg);color:var(--text);margin:0;padding:110px 0 32px}

  /* header + logo (VEƒÜI NAVBAR) */
  header{
    position:fixed;top:0;left:0;right:0;z-index:1000;
    background:#2f5c4e;color:#fff;
    padding:1rem 1.25rem;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 4px 14px rgba(0,0,0,.15);
  }
  .logo-left{position:absolute;left:1rem;display:flex;align-items:center;gap:.5rem}
  .logo-left img{height:80px;width:auto;display:block}
  .title-container{font-size:2.05rem;font-weight:800;letter-spacing:.6px;}
  .dropdown{position:absolute;right:1rem;top:.6rem;}
  .dropdown-toggle{background:var(--btn-bg);color:#fff;border:none;padding:.65rem 1rem;font-size:1.05rem;border-radius:12px;cursor:pointer;}
  .dropdown-toggle:hover{background:var(--btn-bg-hover);}
  .dropdown-content{display:none;position:absolute;top:115%;right:0;min-width:280px;background:var(--card-bg);color:var(--text);border:2px solid var(--card-border);box-shadow:0 12px 30px rgba(0,0,0,.22);border-radius:12px;padding:1rem;backdrop-filter:blur(8px)}
  .dropdown.open .dropdown-content{display:block;}
  .menu-item{width:100%;text-align:left;background:transparent;border:2px solid var(--card-border);color:var(--text);padding:.7rem .85rem;border-radius:12px;cursor:pointer;margin-top:.75rem}
  .menu-item:hover{background:rgba(127,255,212,.06)}
  .menu-line{margin:.7rem 0;border-top:2px dashed var(--card-border);}

  .toggle-row{display:flex;align-items:center;justify-content:space-between;gap:.9rem;border:2px solid var(--card-border);padding:.55rem .7rem;border-radius:12px;}
  .toggle-slider{position:relative;width:68px;height:34px;background:#cfd8dc;border-radius:34px;cursor:pointer;transition:background .25s;}
  .toggle-slider::before{content:"";position:absolute;top:4px;left:4px;width:26px;height:26px;background:#fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.25);transition:transform .25s;}
  #darkToggle{display:none;}
  #darkToggle:checked + .toggle-slider{background:#4caf50;}
  #darkToggle:checked + .toggle-slider::before{transform: translateX(34px);}

  main{max-width:900px;margin:0 auto;padding:16px;}
  .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:1.25rem;box-shadow:0 8px 30px rgba(0,0,0,.18);backdrop-filter: blur(10px);}
  .stack{display:flex;flex-direction:column;gap:1.25rem;}

  #chat-container{display:flex;flex-direction:column;gap:.75rem;max-height:60vh;overflow-y:auto;scroll-behavior:smooth;padding:.25rem .25rem .5rem;border-radius:12px;}
  .chat-message{display:flex;width:100%;word-break:break-word;}
  .user-message{justify-content:flex-end;}
  .bot-message{justify-content:flex-start;}
  .bubble,.bubble.user{padding:.9rem 1.1rem;border-radius:14px;font-size:1rem;line-height:1.7;box-shadow:0 1px 4px rgba(0,0,0,.05);white-space:pre-wrap;background:var(--bubble-bg);color:var(--bubble-text);max-width:75%;animation:fadeIn .25s ease;}
  .bubble{border-left:4px solid var(--accent-bot);margin:.35rem 0;}
  .bubble.user{background:#c8ebf0;border-right:4px solid var(--accent-user);border-left:0!important;margin:.35rem 0 .35rem auto;max-width:60%;}
  body.dark .bubble.user{background:var(--bubble-bg);border-right:4px solid var(--accent-user);}

  /* TIPKANJE ‚Äì indikator sa fazama */
  .typing-indicator{
    position:sticky;bottom:0;align-self:flex-start;font-size:1rem;padding:.6rem .8rem;color:var(--text);
    background:var(--type-bg);border-left:4px solid var(--type-border);border-radius:10px;margin:.15rem 0 0;
    max-width:520px;display:none;z-index:2;font-weight:600;
  }
  .typing-indicator .dots::after{content:'...';animation:dots 1s steps(3,end) infinite;margin-left:.2rem;}
  @keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0)}}

  label{font-weight:600;}
  select, textarea{background:var(--input-bg); color:var(--text);border:1px solid var(--input-border); border-radius:12px;}
  textarea{width:100%;min-height:140px;padding:1rem;font-size:1.08rem;outline:none;resize:vertical;box-shadow:0 2px 8px rgba(0,0,0,.04);}
  textarea:focus{border-color:#3d7d66;box-shadow:0 4px 14px rgba(0,0,0,.08);}

  .btn{background:var(--btn-bg);color:#fff;border:none;padding:.9rem 1.15rem;font-size:1rem;border-radius:12px;cursor:pointer;width:fit-content;transition: transform .05s ease, background .15s ease;}
  .btn:hover{background:var(--btn-bg-hover);} .btn:active{transform:translateY(1px);}
  .btn.secondary{background:transparent;color:var(--btn-bg);border:2px solid var(--btn-bg);}
  .btn.danger{background:var(--danger);}
  .btn.sm{padding:.55rem .75rem;font-size:.95rem;border-radius:10px;}

  .form-actions{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap;padding-top:.75rem;border-top:1px solid var(--card-border);}
  .form-actions .right{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;}

  .error-banner{max-width:900px;margin:12px auto 0;background:#ffe9e9;border:1px solid #f3b8b8;color:#7a1e1e;padding:.8rem 1rem;border-radius:10px;}
  .muted{color:var(--muted);font-size:.95rem}
  .hidden{display:none}

  /* file chip */
  .file-chip{display:none;align-items:center;gap:.5rem;background:#eff6ff;border:1px dashed #b9d2ff;color:#2a4365;padding:.35rem .55rem;border-radius:999px;font-size:.88rem;}
  .file-chip.show{display:inline-flex;}
  .file-chip .remove{background:transparent;border:none;font-size:1rem;cursor:pointer;color:inherit;line-height:1;}

  /* modal */
  .overlay{position:fixed;inset:0;background:var(--overlay);display:none;z-index:1100;}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1101;}
  .modal .box{background:var(--modal-bg);color:var(--text);border:1px solid var(--modal-border);border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,.25);width:min(92vw,520px);padding:1rem;}
  .modal .box h3{margin:.2rem 0 .6rem;font-size:1.25rem}
  .modal .box p{margin:.3rem 0 .9rem}
  .modal .actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.6rem}

  /* start-grade box */
  .grade-start{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;background:#fff6e6;border:2px dashed #f0b25f;padding:.75rem .9rem;border-radius:12px;margin-bottom:.9rem}
  .grade-start label{font-weight:700;margin-right:.25rem}
  .grade-select{font-size:1.08rem;padding:.5rem .8rem;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);min-width:140px;}
  .grade-confirm{padding:.6rem 1rem}

  /* TOAST */
  .toast-wrap{
    position:fixed;left:50%;bottom:120px;transform:translateX(-50%);
    display:flex;flex-direction:column;gap:.6rem;align-items:center;z-index:1200;
    pointer-events:none;
  }
  .toast{
    background:var(--modal-bg);color:var(--text);border:1px solid var(--modal-border);
    border-left:4px solid #f0b25f;border-radius:12px;padding:.75rem 1rem;
    box-shadow:0 10px 30px rgba(0,0,0,.18);min-width:280px;max-width:min(92vw,520px);
    pointer-events:auto;
  }
  .toast.ok{border-left-color:#4caf50}
  .toast.err{border-left-color:#c94f4f}

  .card.is-empty{display:none}
  </style>
</head>
<body>
  <header id="main-header">
    <div class="logo-left">
      <img src="https://s3.amazonaws.com/thinkific-import/307785/cmQxwUYXTjWxCFQJjrA4_MATEMATICAR_3_01_Transparent_png" alt="Matematicari logo">
    </div>
    <div class="title-container">MAT-BOT</div>
    <div class="dropdown" id="menuWrap">
      <button class="dropdown-toggle" onclick="toggleDropdown(event)">‚ò∞ Meni</button>
      <div class="dropdown-content">
        <div class="toggle-row">
          <span class="toggle-label">üåô Dark Mode</span>
          <label style="display:flex;align-items:center;gap:.5rem;">
            <input type="checkbox" id="darkToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="menu-line"></div>

        <button class="menu-item" id="menuClear">üóëÔ∏è Oƒçisti chat‚Ä¶</button>

        <div class="menu-item" id="menuGrades">
          <div style="font-weight:700;margin-bottom:.35rem;">üéì Promijeni razred</div>
          <div style="display:flex;gap:.4rem;flex-wrap:wrap">
            <button class="btn sm secondary grade-btn" data-grade="5">5</button>
            <button class="btn sm secondary grade-btn" data-grade="6">6</button>
            <button class="btn sm secondary grade-btn" data-grade="7">7</button>
            <button class="btn sm secondary grade-btn" data-grade="8">8</button>
            <button class="btn sm secondary grade-btn" data-grade="9">9</button>
          </div>
          <div class="muted" style="margin-top:.4rem">Trenutni: <span id="curGradeLabel">‚Äî</span></div>
        </div>
      </div>
    </div>
  </header>

  <main class="stack">
    <!-- CHAT -->
    <div class="card is-empty" id="chat-card">
      <div id="chat-container"></div>
      <div id="typing" class="typing-indicator" aria-live="polite">
        ü§ñ <span id="phaseText">Razmi≈°ljam</span><span class="dots"></span>
      </div>
    </div>

    <!-- FORMA -->
    <div class="card">
      <div id="grade-start" class="grade-start">
        <label for="gradeSelectStart">Koji si razred?</label>
        <select id="gradeSelectStart" class="grade-select" aria-label="Razred">
          <option value="" selected disabled>‚Äî odaberi ‚Äî</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
        </select>
        <button id="gradeConfirmStart" class="btn secondary sm grade-confirm">Potvrdi</button>
      </div>

      <form id="ask-form" method="POST" enctype="multipart/form-data" autocomplete="off" action="/submit">
        <input type="hidden" id="razredHidden" name="razred" value="">
        <input type="hidden" id="history_json_main" name="history_json" value="[]">

        <label for="pitanje">Postavi mi matematiƒçko pitanje (tekst ili slika):</label>
        <textarea name="pitanje" id="pitanje" placeholder="Ovdje mo≈æe≈° unijeti zadatak ili pitanje..." disabled></textarea>

        <div class="form-actions">
          <div class="left">
            <input id="slika" type="file" name="file" accept="image/*" style="display:none;" disabled />
            <label for="slika" id="uploadLabel" class="btn secondary sm" aria-disabled="true">üì§ Upload slike</label>
            <span id="file-chip" class="file-chip">
              <span id="file-name">Nije odabran fajl</span>
              <button type="button" class="remove" id="remove-file" title="Ukloni fajl">√ó</button>
            </span>
          </div>
          <div class="right">
            <button id="sendBtn" type="button" class="btn" disabled>‚úâÔ∏è Po≈°alji</button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <div class="toast-wrap" id="toastWrap"></div>
  <div class="overlay" id="overlay"></div>

  <div class="modal" id="confirm-clear">
    <div class="box">
      <h3>Oƒçisti chat?</h3>
      <p>Ova radnja bri≈°e cijelu konverzaciju. Ne mo≈æe se poni≈°titi.</p>
      <div class="actions">
        <button class="btn secondary" data-close="#confirm-clear">Odustani</button>
        <button class="btn danger" id="doClear">Obri≈°i</button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirm-grade">
    <div class="box">
      <h3>Promjena razreda</h3>
      <p id="gradeMsg">Promijeniti razred?</p>
      <div class="actions">
        <button class="btn secondary" data-close="#confirm-grade">Odustani</button>
        <button class="btn" id="doGrade">Potvrdi</button>
      </div>
    </div>
  </div>

<script>
/* --- MENI & TEMA --- */
function toggleDropdown(e){ e.preventDefault(); document.getElementById('menuWrap').classList.toggle('open'); }
function closeDropdown(){ document.getElementById('menuWrap')?.classList.remove('open'); }
function initDarkToggle(){
  const cb = document.getElementById('darkToggle');
  const saved = localStorage.getItem('matbot_dark') === '1';
  if (saved){ document.body.classList.add('dark'); cb.checked = true; }
  cb.addEventListener('change', ()=>{ document.body.classList.toggle('dark', cb.checked); localStorage.setItem('matbot_dark', cb.checked ? '1' : '0');});
}

/* --- TIPKANJE: rotirajuƒáe faze --- */
let phaseTimer=null;
function showTyping(){
  const t = document.getElementById('typing');
  const phase = document.getElementById('phaseText');
  const phases = ["Razmi≈°ljam o zadatku", "Sastavljam odgovor uz korake", "Molim za strpljenje, skoro gotovo"];
  let i = 0;
  phase.textContent = phases[i];
  clearInterval(phaseTimer);
  phaseTimer = setInterval(()=>{ i = (i+1)%phases.length; phase.textContent = phases[i]; }, 2200);
  document.getElementById('chat-card')?.classList.remove('is-empty');
  t.style.display='block';
}
function hideTyping(){
  clearInterval(phaseTimer);
  document.getElementById('typing').style.display='none';
}
function scrollToBottom(){ const chat=document.getElementById('chat-container'); if(chat) chat.scrollTop = chat.scrollHeight; }

/* --- MODALI --- */
function openModal(id){ document.getElementById('overlay').style.display='block'; document.querySelector(id).style.display='flex'; }
function closeModal(id){ document.getElementById('overlay').style.display='none'; document.querySelector(id).style.display='none'; }
document.getElementById('overlay').addEventListener('click', ()=>{ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); document.getElementById('overlay').style.display='none'; });
document.addEventListener('click',(e)=>{ const closeSel=e.target.getAttribute?.('data-close'); if (closeSel){ e.preventDefault(); closeModal(closeSel); }});

/* auto-zatvori meni klikom izvan */
document.addEventListener('click', (e)=>{
  const menu = document.getElementById('menuWrap');
  if(!menu) return;
  if(!menu.contains(e.target) && menu.classList.contains('open')) menu.classList.remove('open');
});

/* --- TOAST --- */
function showToast(msg, type='warn', timeout=2600){
  const wrap = document.getElementById('toastWrap');
  if(!wrap) return;
  wrap.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'toast ' + (type==='ok' ? 'ok' : type==='err' ? 'err' : '');
  div.textContent = msg;
  wrap.appendChild(div);
  setTimeout(()=>{ div.remove(); }, timeout);
}

/* ====== HISTORY HELPERS ====== */
function getCID(){
  const key='matbot_cid';
  if(!localStorage.getItem(key)){
    const cid = (crypto.randomUUID)? crypto.randomUUID() : (Date.now()+'_'+Math.random());
    localStorage.setItem(key,cid);
  }
  return localStorage.getItem(key);
}
function resetHistory(HIST_KEY, hidden){
  localStorage.removeItem(HIST_KEY);
  if (hidden) hidden.value = '[]';
}
function pushHistory(HIST_KEY, user, bot){
  let arr=[]; try{ arr = JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); }catch(_){}
  arr.push({user, bot});
  arr = arr.slice(-8);
  localStorage.setItem(HIST_KEY, JSON.stringify(arr));
  const hidden = document.getElementById('history_json_main');
  if (hidden) hidden.value = JSON.stringify(arr.slice(-5));
}

document.addEventListener('DOMContentLoaded', () => {
  initDarkToggle();

  /* ====== 1) SAMO UNUTAR THINKIFICA (iframe check) ====== */
  const isIframe = (window.top !== window.self);
  const urlParams = new URLSearchParams(location.search);
  const hasBypassToken = urlParams.get('from') === 'thinkific' && !!urlParams.get('t');
  if(!(isIframe || hasBypassToken)){
    document.body.innerHTML = `
      <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;text-align:center">
        <div style="background:var(--card-bg);border:1px solid var(--card-border);padding:1.2rem 1.4rem;border-radius:14px;max-width:640px;box-shadow:0 10px 40px rgba(0,0,0,.18)">
          <h2 style="margin:.2rem 0 0.6rem">Pristup ograniƒçen</h2>
          <p>Ova aplikacija je dostupna <strong>samo unutar Thinkific platforme</strong>.</p>
          <p class="muted">Otvorite lekciju u Thinkificu da biste koristili MAT-BOT.</p>
        </div>
      </div>`;
    return;
  }

  /* ====== 2) OBRI≈†I RAZRED NA REFRESH ====== */
  try{
    localStorage.removeItem('mb_grade_confirmed');
    localStorage.removeItem('mb_grade_value');
  }catch(_){}
  const razredHidden = document.getElementById('razredHidden');
  if (razredHidden) razredHidden.value = "";
  document.getElementById('curGradeLabel').textContent = '‚Äî';

  /* ====== Inic i elementi ====== */
  const form = document.getElementById('ask-form');
  const sendBtn = document.getElementById('sendBtn');
  const textarea = document.getElementById('pitanje');
  const fileInput = document.getElementById('slika');
  const uploadLabel = document.getElementById('uploadLabel');
  const fileChip = document.getElementById('file-chip');
  const fileName = document.getElementById('file-name');
  const removeFileBtn = document.getElementById('remove-file');
  const chat = document.getElementById('chat-container');

  /* ====== HISTORY INIT ====== */
  const hiddenHistory = document.getElementById('history_json_main');
  const HIST_KEY = 'matbot_history_' + getCID();
  try{
    const arr = JSON.parse(localStorage.getItem(HIST_KEY) || '[]');
    hiddenHistory.value = JSON.stringify((Array.isArray(arr)?arr:[]).slice(-5));
  }catch(_){
    hiddenHistory.value = '[]';
  }

  /* enable/disable unosa */
  function setInputsEnabled(on){
    textarea.disabled = !on;
    fileInput.disabled = !on;
    sendBtn.disabled = !on;
    uploadLabel.setAttribute('aria-disabled', on ? 'false' : 'true');
    uploadLabel.style.opacity = on ? '1' : '.6';
  }

  /* ------ START RAZRED BOX ------ */
  const gradeStart = document.getElementById('grade-start');
  const gradeSelStart = document.getElementById('gradeSelectStart');
  const gradeBtnStart = document.getElementById('gradeConfirmStart');
  setInputsEnabled(false);

  gradeBtnStart.addEventListener('click', ()=>{
    const g = gradeSelStart.value;
    if(!g){ showToast('Prvo odaberi razred.', 'err'); return; }
    razredHidden.value = g;
    document.getElementById('curGradeLabel').textContent = g;
    gradeStart.classList.add('hidden');
    gradeStart.style.display = 'none';
    setInputsEnabled(true);
    showToast(`Razred postavljen na ${g}.`, 'ok');
  });

  /* file chip + validacija */
  function updateFileUI(){
    if(fileInput.files && fileInput.files[0]){
      const f = fileInput.files[0];
      if (!f.type || !f.type.startsWith('image/')) {
        clearFile();
        showToast('To nije slika. Po≈°alji JPG/PNG ili tekst zadatka.', 'err');
        return;
      }
      fileName.textContent = f.name;
      fileChip.classList.add('show');
    }else{
      fileName.textContent = 'Nije odabran fajl';
      fileChip.classList.remove('show');
    }
  }
  function clearFile(){
    const dt = new DataTransfer();
    fileInput.files = dt.files;
    fileInput.value = "";
    fileChip.classList.remove('show');
    fileName.textContent='Nije odabran fajl';
  }
  fileInput.addEventListener('change', updateFileUI);
  removeFileBtn.addEventListener('click', clearFile);

  /* meni: clear */
  document.getElementById('menuClear').addEventListener('click', (e)=>{ e.preventDefault(); openModal('#confirm-clear'); closeDropdown(); });
  document.getElementById('doClear').addEventListener('click', async ()=>{
    const chatEmpty = !document.querySelector('#chat-container .chat-message');
    if (chatEmpty){
      showToast('Chat je veƒá prazan.', 'warn');
      closeModal('#confirm-clear');
      return;
    }
    try{
      const fd = new URLSearchParams({confirm_clear:"1", ajax:"1"});
      await fetch("/clear",{method:"POST", body:fd, credentials:"include"});
    }catch(_){}
    resetHistory(HIST_KEY, hiddenHistory);
    closeModal('#confirm-clear');
    location.reload();
  });

  /* promjena razreda kroz meni */
  document.querySelectorAll('.grade-btn').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.preventDefault();
      const g = btn.dataset.grade;
      document.getElementById('gradeMsg').textContent = `Promijeniti razred na ${g} i obrisati chat?`;
      document.getElementById('doGrade').setAttribute('data-grade', g);
      openModal('#confirm-grade'); closeDropdown();
    });
  });
  document.getElementById('doGrade').addEventListener('click', async (e)=>{
    const g = e.target.getAttribute('data-grade');
    if(!g) return;
    try{
      const fd = new FormData(); fd.append("razred", g);
      const r = await fetch("/set-razred",{method:"POST", body:fd, credentials:"include"});
      if(r.ok){
        razredHidden.value = g;
        closeModal('#confirm-grade');
        location.reload();
      }
    }catch(_){
      closeModal('#confirm-grade');
    }
  });

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  function appendUserBubble(opts){
    const wrap = document.createElement('div');
    wrap.className = 'chat-message user-message';
    const bubble = document.createElement('div');
    bubble.className = 'bubble user';
    let html = '';
    if (opts.text && opts.text.trim()) html += `<p>${escapeHtml(opts.text)}</p>`;
    if (opts.fileName) html += `<p><strong>üì∑ ${escapeHtml(opts.fileName)}</strong></p>`;
    if (!html) html = '<p><em>(prazna poruka)</em></p>';
    bubble.innerHTML = html;
    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    scrollToBottom();
  }
  function appendBotHTML(html){
    const wrap = document.createElement('div');
    wrap.className = 'chat-message bot-message';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = html || '<i>Nema odgovora.</i>';
    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise([bubble]);
    applyPlotsIn(bubble);
    scrollToBottom();
  }

  async function sendOne(){
    const razred = razredHidden.value;
    const text = textarea.value.trim();
    const file = fileInput.files[0];

    const userLabel = text || (file ? file.name : '(prazno)');
    window.__lastUserLabel = userLabel;

    if(!razred){ showToast('Prvo postavi razred.', 'err'); return; }
    if(!text && !file){ showToast('Unesi pitanje ili dodaj sliku prije slanja.', 'err'); return; }
    if(file && (!file.type || !file.type.startsWith('image/'))){
      showToast('Fajl nije prepoznat kao slika. Po≈°alji JPG/PNG ili samo tekst.', 'err'); return;
    }

    document.getElementById('chat-card')?.classList.remove('is-empty');
    showTyping();
    sendBtn.disabled = true;
    textarea.disabled = true;
    document.querySelectorAll('.grade-btn').forEach(b=>b.disabled=true);

    appendUserBubble({text, fileName: file ? file.name : ''});
    textarea.value = '';
    clearFile();

    const fd = new FormData();
    fd.append('razred', razred);
    if (text) fd.append('user_text', text);
    if (file) fd.append('file', file, file.name);
    const hiddenMain = document.getElementById('history_json_main');
    if (hiddenMain && hiddenMain.value) {
      fd.append('history_json', hiddenMain.value);
    }

    let keepTyping = false;
    try{
      const r = await fetch(form.action || '/submit', { method:'POST', body: fd, credentials:'include' });
      const ct = r.headers.get('content-type') || '';
      const isJSON = ct.includes('application/json');
      if (r.status === 409){
        appendBotHTML('<div class="alert alert-warning">Veƒá se generi≈°e jedan odgovor. Saƒçekaj trenutak.</div>');
      } else if (!r.ok){
        const t = isJSON ? JSON.stringify(await r.json()) : await r.text();
        appendBotHTML(`<div class="alert alert-danger">Gre≈°ka: ${escapeHtml(t)}</div>');
      } else {
        const j = isJSON ? await r.json() : {};
        if (j.mode && j.job_id && !j.result){
          keepTyping = true;
          poll(j.job_id);
        } else {
          const html = (j && j.result && j.result.html) ? j.result.html : '<i>Nema rezultata.</i>';
          appendBotHTML(html);
          pushHistory(HIST_KEY, userLabel, html);
        }
      }
    } catch (e){
      appendBotHTML('<div class="alert alert-danger">Gre≈°ka pri slanju zahtjeva.</div>');
    } finally {
      if (!keepTyping) hideTyping();
      sendBtn.disabled = false;
      textarea.disabled = false;
      document.querySelectorAll('.grade-btn').forEach(b=>b.disabled=false);
    }
  }

  async function poll(jobId){
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    for (let i=0;i<180;i++){
      await sleep(2000);
      try{
        const r = await fetch(`/status/${jobId}`, {cache:'no-store', credentials:'include'});
        if (!r.ok) throw new Error('status http '+r.status);
        const data = await r.json();
        if (data.status === 'done'){
          const html = (data.result && data.result.html) ? data.result.html : '<i>Nema rezultata.</i>';
          appendBotHTML(html);
          pushHistory(HIST_KEY, window.__lastUserLabel || '(follow-up)', html);
          hideTyping(); return;
        }
        if (data.status === 'error'){
          appendBotHTML('<div class="alert alert-danger">Gre≈°ka u asinkronoj obradi.</div>');
          hideTyping(); return;
        }
      }catch(_){
        appendBotHTML('<div class="alert alert-danger">Gre≈°ka pri provjeri statusa.</div>');
        hideTyping(); return;
      }
    }
    appendBotHTML('<div class="alert alert-warning">Istek vremena ƒçekanja na rezultat.</div>');
    hideTyping();
  }

  document.getElementById('sendBtn').addEventListener('click', sendOne);
  form.addEventListener('submit',(e)=>{ e.preventDefault(); sendOne(); });
});

/* ------- Plot helpers ------- */
function transformExpression(expr){
  return expr.replace(/\s+/g,'')
    .replace(/([0-9])([a-zA-Z])/g,'$1*$2')
    .replace(/([a-zA-Z])([a-zA-Z])/g,'$1*$2')
    .replace(/([a-zA-Z])(\d)/g,'$1*$2')
    .replace(/(\))(\()/g,'$1*$2')
    .replace(/(\))([a-zA-Z])/g,'$1*$2')
    .replace(/([a-zA-Z])(\()/g,'$1*$2')
    .replace(/(\d+|\w+)\^(\d+|\w+)/g,'Math.pow($1,$2)')
    .replace(/(?<!\.)\b(sin|cos|tan|exp|log|sqrt|abs)\b/g,'Math.$1')
    .replace(/\bln\b/g,'Math.log');
}
function drawPlot(expression, container){
  const parsed = transformExpression(expression);
  const x=[], y=[]; let f;
  try{ f=new Function('x',`return ${parsed}`); }catch(e){ return; }
  for(let i=-10;i<=10;i+=0.1){
    try{ const res=f(i); x.push(i); y.push(isFinite(res)?res:null);}catch{ x.push(i); y.push(null);}
  }
  const styles = getComputedStyle(document.body);
  const paperBg = styles.getPropertyValue('--card-bg').trim() || '#fff';
  const textCol = styles.getPropertyValue('--text').trim() || '#111';
  const data=[{x,y,mode:'lines',line:{width:3},name:expression}];
  const layout={
    title:`Graf funkcije: y = ${expression}`,
    xaxis:{title:'x',color:textCol,tickcolor:textCol,gridcolor:'rgba(255,255,255,.08)'},
    yaxis:{title:'y',color:textCol,tickcolor:textCol,gridcolor:'rgba(255,255,255,.08)'},
    margin:{t:40},plot_bgcolor:paperBg,paper_bgcolor:paperBg
  };
  const graphDiv=document.createElement("div");
  graphDiv.style="width:100%;max-width:700px;height:400px;margin-top:1rem;";
  container.appendChild(graphDiv);
  Plotly.newPlot(graphDiv,data,layout);
}
function applyPlotsIn(root){
  root.querySelectorAll('.plot-request').forEach(plotDiv=>{
    let expression=plotDiv.getAttribute("data-expression");
    const parent=plotDiv.closest(".bubble") || root;
    if(!expression||!parent) return;
    if(expression.trim().startsWith("y=")) expression=expression.replace(/^y\s*=\s*/i,"").trim();
    drawPlot(expression,parent);
    plotDiv.remove();
  });
}
</script>
</body>
</html>
