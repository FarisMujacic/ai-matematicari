cat > ~/matbot-refresh.sh <<'SH'
#!/usr/bin/env bash
set -euo pipefail

PROJECT_ID="$(gcloud config get-value project)"
REGION="europe-west1"
SERVICE="matbot"
REPO="https://github.com/CORBiH/ai-matematicari.git"
BRANCH="main"   # promijeni ako ti je druga grana (npr. master)

echo "Project: $PROJECT_ID | Region: $REGION | Service: $SERVICE | Branch: $BRANCH"

# Svježi klon
rm -rf /tmp/ai-matematicari
git clone --depth 1 --branch "$BRANCH" "$REPO" /tmp/ai-matematicari
cd /tmp/ai-matematicari
echo "Git rev: $(git rev-parse --short HEAD)"

# Odaberi build config iz repoa (preferiraj cloudbuild.json)
if [[ -f cloudbuild.json ]]; then
  CFG=cloudbuild.json
elif [[ -f cloudbuild.yaml ]]; then
  CFG=cloudbuild.yaml
else
  echo "❌ Nema cloudbuild.json ni cloudbuild.yaml u repo rootu." >&2
  exit 1
fi
echo "Koristim build config: $CFG"

# Brzi sintaksni test Python koda (ne obavezan, samo info)
python -m py_compile app.py || true

# Build+deploy preko Cloud Build-a
gcloud builds submit --config "$CFG" .

# Provjera nakon deploya
RUN_URL="$(gcloud run services describe "$SERVICE" --region "$REGION" --format='value(status.url)')"
echo "Run URL: $RUN_URL"

echo "---- Health (_ah/health) ----"
curl -fsS -o /dev/null -w "%{http_code}\n" "$RUN_URL/_ah/health" || true

echo "---- /submit quick test ----"
curl -fsS -X POST "$RUN_URL/submit" -F 'razred=6' -F 'user_text=Koliko je 2+3?' || true

echo "Done."
SH
chmod +x ~/matbot-refresh.sh
